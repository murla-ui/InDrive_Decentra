# InDrive Geoanalytics — документация
> Прототип интерактивной геоаналитики для дорожной безопасности и пропускной способности улично-дорожной сети.

## [inDrive GeoAnalytics](https://murla-ui.github.io/InDrive_Decentra/)
## [Link to the Demo Video and Presentation](https://drive.google.com/drive/folders/16Nnz7wq4OQvk5ukCI8QLzXCTs6n68vKE?usp=sharing)


## Содержание
- [Кратко о прототипе](#кратко-о-прототипе)
- [Модули и функциональность](#модули-и-функциональность)
  - [Модуль безопасности](#модуль-безопасности)
  - [Модуль оптимизации](#модуль-оптимизации)
- [Как это работает (алгоритмы)](#как-это-работает-алгоритмы)
- [Данные: входы и выходы](#данные-входы-и-выходы)
  - [Входные файлы](#входные-файлы)
  - [Выходные файлы](#выходные-файлы)
- [Структура репозитория](#структура-репозитория)
- [Запуск и быстрый старт](#запуск-и-быстрый-старт)
  - [Локальный просмотр HTML-карт](#локальный-просмотр-html-карт)
  - [Скрипт `route_endpoints.py`](#скрипт-route_endpointspy)
  - [Ноутбуки](#ноутбуки)
- [Технологический стек](#технологический-стек)
- [Дальнейшие шаги](#дальнейшие-шаги)
- [Лицензия и атрибуция](#лицензия-и-атрибуция)

---

## Кратко о прототипе
Интерактивные веб-карты (статические HTML) для:
- оценки **рисков безопасности** (школы, жилые зоны, превышения скорости, камеры);
- анализа **пропускной способности** по направлениям движения, стартам/финишам и плотности поездок.

Все визуализации работают офлайн из файлов CSV (без серверной части).

---

## Модули и функциональность

### Модуль безопасности
- **Карта риска возле школ.** Если на участках дорог рядом со школой есть точки с превышением скорости **> 40 км/ч**, подсвечиваем их как зоны повышенного риска для детей.
- **Риски во дворах (жилые зоны).** Превышения **> 20 км/ч** на дорогах в жилых кварталах показывают потенциально опасные дворовые зоны. Классификация дорог взята из **OpenStreetMap**.
- **Улицы с наибольшим риском аварии.** Отображаем улицы и сегменты, где систематически фиксируются превышения — индикатор повышенной аварийности.
- **Камеры и нарушения.** Показываем расположение камер и участки, где рядом с камерами нарушают чаще — где больше фиксируется правонарушений.

### Модуль оптимизации
- **Плотность всех точек.** Теплокарта плотности GPS-точек показывает популярные участки — где водители проезжают чаще.
- **Старты и финиши.** Карта начальных и конечных точек поездок. Из-за обрезки маршрутов (радиус вокруг EXPO) видно, откуда заезжают/выезжают. Начальные/конечные точки определены через **k-Nearest Neighbors (k-NN)** и **Minimum Spanning Tree (MST)** для каждой поездки.
- **Пропускная способность (direction clusters).** Кластеры направлений на базе векторов движения и графовой структуры: где чаще образуются заторы, где движение свободнее.

---

## Как это работает (алгоритмы)
- Для каждого `randomized_id`:
  1. Перевод координат в локальные метры → корректная евклидова метрика.
  2. Построение **kNN-графа** → извлечение **минимального остовного дерева (MST)**.
  3. Поиск **диаметра MST** — двух наиболее удалённых точек по кратчайшему пути (геометрические «концы верёвки»).
  4. Построение «хребта» маршрута по кратчайшему пути между концами и различение **Start/End**:
     - если есть `azm` — по совпадению азимута с направлением хребта на концах;
     - иначе — *fallback* по скорости `spd` (**старт = более «медленный» конец**).

---

## Данные: входы и выходы

### Входные файлы
- **`final_speed.csv`** — сырые/агрегированные точки:
  - колонки: `lat`, `lng`, `spd`, `azm`, `randomized_id`;
  - примечание: если средняя `spd` > 15 — значения трактуются как км/ч и конвертируются в м/с.
- **`direction_clusters.csv`** — свод по кластерам направлений:
  - координаты: `centroid_lat`|`lat`, `centroid_lng`|`lng`;
  - скорость: `avg_spd_ms`|`spd_ms`; направление: `avg_azm`|`azm`; опционально `cnt`.
- **`schools_expo.csv`** — точки школ/соц. объектов для контекстных слоёв.
- **`df_cams.csv`** — точки камер наблюдения.

### Выходные файлы
- **`route_endpoints.csv`** — рассчитанные старты/финиши по каждой поездке:
  ```randomized_id,start_lat,start_lng,end_lat,end_lng```
- **`fastest_route.html`** — экспорт построенного маршрута (цвет сегмента = нормированная скорость).
- **`vectors_direction_clusters.html`** *(опционально)* — предпросмотр векторов направлений.

---

## Структура репозитория
- `index.html` — галерея с переходами на визуализации.
- `Safety.html` — карта рисков/инцидентов и контекстные слои (школы, камеры).
- `Optimisation.html` — визуализации потоков, направлений и плотности.
- `route_endpoints.py` — CLI-скрипт: расчёт начала/конца маршрутов, (опц.) предпросмотр.
- `route_optimization.ipynb` — интерактив: выбор Start/End кликом и экспорт маршрута.
- `EDA_Data_Cleaning.ipynb` — первичная EDA и очистка (координаты, дубликаты, шумы, таймстемпы, базовая агрегация).
- `schools_expo.csv`, `df_cams.csv`, `final_speed.csv`, `direction_clusters.csv`, `route_endpoints.csv`
- `safety.bmp`, `business.bmp` — обложки/превью для галереи.

---

## Запуск и быстрый старт

### Локальный просмотр HTML-карт
Любой статический сервер подойдёт:
```bash
# Python
python -m http.server 8000

# Node
npx serve .
```
### Откройте в браузере
- http://localhost:8000/index.html
- Либо напрямую: Safety.html / Optimisation.html

> Все карты читают CSV из той же директории (через PapaParse), интернет не обязателен.

---

## Скрипт `route_endpoints.py`

**Пример запуска:**
python route_endpoints.py /path/to/final_speed.csv --no-heatmap

**Что делает:**
- читает CSV с колонками `randomized_id`, `lat`, `lng` (опц.: `spd`, `azm`);
- для каждого `randomized_id` строит kNN-граф → MST, находит диаметр и «хребет» маршрута;
- определяет Start/End (по `azm`, иначе по `spd`);
- сохраняет `route_endpoints.csv` с колонками:
randomized_id,start_lat,start_lng,end_lat,end_lng

---

## Ноутбуки

### `route_optimization.ipynb` — быстрый старт
1. Откройте ноутбук.
2. Установите зависимости (ячейка вверху).
3. Запустите все ячейки:
   - клик по карте: 1-й — Start, 2-й — End, 3-й — сброс;
   - кнопка Open route in new window сохранит fastest_route.html.

### `EDA_Data_Cleaning.ipynb`
- первичная EDA и cleaning: проверка координат/дубликатов, фильтрация шумов, нормализация таймстемпов, базовая агрегация по поездкам;
- итогом являются упрощённые CSV-выгрузки для карт.

---

## Технологический стек
- Веб-визуализация: MapLibre GL JS, deck.gl, Turf.js, PapaParse
- Python/анализ: pandas, numpy, (kNN/MST), folium (экспорт маршрутов)
- Формат данных: CSV; работает офлайн как статический сайт

---

## Дальнейшие шаги
- обогащение модели риска (взвешивание по времени суток/дню недели);
- нормализация по интенсивности трафика и exposure (пробеги, частота);
- улучшение выделения дворов/жилых зон и буферов вокруг школ;
- сшивка разрозненных поездок в траектории и выявление рекуррентных шаблонов;
- экспорт геослоёв (GeoJSON/MBTiles) и публикация тайлов.

---

## Лицензия и атрибуция
- Классификация дорог: OpenStreetMap (атрибуция согласно лицензии проекта).
